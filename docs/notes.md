# Running Notes

## 2026-02-19
- Counter background asset refresh (TI + RI tournament summary tiles):
  - Added/updated shared sport counter assets:
    - `shared-assets/svg/sports/soccer_count_badge.svg`
    - `shared-assets/svg/sports/basketball_count_badge.svg`
    - `shared-assets/svg/sports/lacrosse_counter_badge.svg`
    - `shared-assets/svg/sports/total_tournaments_count.svg`
    - updated `shared-assets/svg/sports/baseball_badge.svg`
    - updated `shared-assets/svg/sports/softball_badge.svg`
  - Applied sport-specific counter background classes (`summary-sport-*`) so soccer/basketball/lacrosse counters can use dedicated artwork independently of tournament card surfaces.
  - Added `summary-total` background styling for the total tournaments tile.
  - Tuned soccer/baseball crop/zoom in counter tiles to remove embedded frame/shadow artifacts from source art.
  - Tournament cards no longer show the extra baseball/softball badge block; badges remain counter-only.
  - Files:
    - `apps/ti-web/app/tournaments/page.tsx`
    - `apps/referee/app/tournaments/page.tsx`
    - `apps/ti-web/app/tournaments/tournaments.css`
    - `apps/referee/app/tournaments/tournaments.css`

- Admin venues list + address verify improvements:
  - Added `Venue URL` display to expandable admin venue row details (clickable when present).
  - Added non-destructive `Remove from list` action per venue row to hide verified rows in current admin view.
  - `Venue Address Verify` parser now normalizes `address/address1` to street-only when city/state/zip are parsed from embedded address blobs (removes duplicated locality from address fields).
  - Files:
    - `apps/referee/components/admin/VenueRow.tsx`
    - `apps/referee/components/admin/VenueActions.tsx`
    - `apps/referee/app/admin/venues/page.tsx`
    - `apps/referee/app/api/admin/venues/address-verify/route.ts`

- Admin venues visibility + workflow updates:
  - Added `Venue URL` to the expandable admin venue row details (clickable when present).
  - Added per-row `Remove from list` action in admin venues list to hide verified items from the current view without deleting data.
  - Files:
    - `apps/referee/components/admin/VenueRow.tsx`
    - `apps/referee/components/admin/VenueActions.tsx`
    - `apps/referee/app/admin/venues/page.tsx`

- Sports badge asset replacements/tuning:
  - Replaced baseball badge source with `baseball_new_bg.svg` content in:
    - `shared-assets/svg/sports/baseball_badge.svg`
  - Replaced softball badge source with `softball_new_bg.svg` content in:
    - `shared-assets/svg/sports/softball_badge.svg`
  - Counter widgets now use baseball/softball badge art as tile backgrounds; tournament cards no longer render the extra badge block overlay.
  - Files:
    - `apps/ti-web/app/tournaments/tournaments.css`
    - `apps/referee/app/tournaments/tournaments.css`

- Baseball/softball counter + card badge follow-up tuning:
  - Clarified icon behavior:
    - Restored baseball/softball counter/card icons to balls (`âš¾`, `ðŸ¥Ž`) while keeping badge SVGs as background treatments.
  - Replaced baseball badge source with a new text-free asset:
    - copied `/Users/roddavis/Downloads/artwork/baseball_new_bg.svg` over `shared-assets/svg/sports/baseball_badge.svg`.
  - Synced shared assets to app public folders via `node scripts/copy-shared-svg.js`.
  - Counter-widget background treatment updates (TI + RI):
    - baseball/softball summary cards now use badge SVG as full tile background (instead of centered icon replacement).
    - removed summary-card `backdrop-filter` blur so badge artwork renders crisp.
    - added summary-card readability overlay + z-index layering for count/label readability.
    - tuned baseball summary crop/zoom (`background-size`/`background-position`) to hide embedded frame/shadow artifacts from source art.
  - Files touched:
    - `apps/ti-web/app/tournaments/page.tsx`
    - `apps/ti-web/app/venues/page.tsx`
    - `apps/ti-web/app/tournaments/tournaments.css`
    - `apps/referee/app/tournaments/page.tsx`
    - `apps/referee/app/tournaments/[slug]/page.tsx`
    - `apps/referee/app/tournaments/hubs/_components/SportHubPage.tsx`
    - `apps/referee/app/tournaments/tournaments.css`

- Baseball/softball badge asset + card treatment updates (TI + RI):
  - Added shared sport badge assets:
    - `shared-assets/svg/sports/baseball_badge.svg`
    - `shared-assets/svg/sports/softball_badge.svg`
  - Replaced baseball counter/tile icon usage with `baseball_badge.svg` and added softball icon rendering in tournament/venue sport icon helpers.
  - Added `softball` sport surface class support and background styling (`bg-sport-softball`) for tournament cards/detail surfaces, including schools/hub card variants.
  - Updated files:
    - `apps/ti-web/app/tournaments/page.tsx`
    - `apps/ti-web/app/tournaments/[slug]/page.tsx`
    - `apps/ti-web/app/venues/page.tsx`
    - `apps/ti-web/app/tournaments/tournaments.css`
    - `apps/referee/app/tournaments/page.tsx`
    - `apps/referee/app/tournaments/[slug]/page.tsx`
    - `apps/referee/app/tournaments/hubs/_components/SportHubPage.tsx`
    - `apps/referee/app/tournaments/tournaments.css`
    - `apps/referee/lib/ui/sportBackground.ts`
  - Synced assets to app public folders via `node scripts/copy-shared-svg.js`.
  - Validation:
    - `npx tsc -p apps/ti-web/tsconfig.json --noEmit` passed.
    - `npx tsc -p apps/referee/tsconfig.json --noEmit` passed.

- Sources admin production render fix:
  - Fixed `/admin/tournaments/sources` server-render crash caused by capturing a `URLSearchParams` object inside server action closures.
  - Replaced closure-captured `URLSearchParams` with plain serialized query string + per-call reconstruction.
  - This stabilizes action redirects and prevents generic â€œUnable to load adminâ€ failures on production builds.
  - File:
    - `apps/referee/app/admin/tournaments/sources/page.tsx`

- Admin dashboard organization + maintenance widgets:
  - Added a new `Tournaments Dashboard` section on `/admin` with clickable widgets for:
    - tournaments by sport (all sports present in DB)
    - tournaments missing venues
    - tournaments missing URLs
    - tournaments missing dates
    - venues missing address/lat-long
    - venues missing URLs
  - Widgets deep-link into existing maintenance UIs (no duplicate edit surfaces):
    - tournament listings filters: `tab=tournament-listings&sport=...` and `missing=venues|urls|dates`
    - venue filters: `/admin/venues?missing=address_geo|urls`
  - Tournament listings UI updates:
    - Added sport dropdown to tournament-listings search form.
    - Added active-filter chips for sport/missing filters.
    - Missing-data filters now scope the existing collapsed edit/delete list.
  - Venue admin UI updates:
    - Added missing-data filter support in venues list query (`address_geo`, `urls`).
    - Added lacrosse/baseball options to venue sport filter.
  - Files:
    - `apps/referee/app/admin/page.tsx`
    - `apps/referee/lib/admin.ts`
    - `apps/referee/app/admin/venues/page.tsx`

- Venue edit header usability:
  - `/admin/venues/[id]` now shows a clickable `venue_url` (when present) above the `Venue ID` line.
  - File:
    - `apps/referee/app/admin/venues/[id]/page.tsx`

- USSSA baseball unified parser + source registry scaling controls:
  - Added a single USSSA baseball sweep pipeline that can:
    - discover state sources from `https://usssa.com/baseball_events`
    - iterate state `.../state-tournaments/` pages
    - parse/import events as baseball tournaments
    - queue enrichment for imported tournaments
  - New sweep module:
    - `apps/referee/src/server/sweeps/usssaBaseballTournaments.ts`
  - Wired into source sweep flow:
    - `apps/referee/src/server/admin/pasteUrl.ts`
    - USSSA directory/state URLs now route to dedicated USSSA sweep branch.
  - Registry seeding behavior:
    - USSSA root + state pages are upserted as `is_custom_source=true` so rows show in the green custom style.
  - Added baseball to admin/sweep sport allowlists + canonical tournament typing:
    - `apps/referee/app/admin/page.tsx`
    - `apps/referee/app/admin/tournaments/sources/page.tsx`
    - `apps/referee/lib/types/tournament.ts`
- Source registry filter persistence fix:
  - Fixed `/admin/tournaments/sources` so active filters (`filter`, `q`, `sport`, `state`, `sort`, `dir`, `source_url`) are preserved after:
    - status save
    - quick actions
    - sweep actions
  - File:
    - `apps/referee/app/admin/tournaments/sources/page.tsx`

- Venue restrooms + player parking updates:
  - Fixed venue save failures on restrooms by normalizing common variants in venue PATCH API (`portables` -> `portable`, etc.) and switching admin restrooms inputs to constrained dropdown options (`portable`, `building`, `both`).
  - Added venue-level `player_parking` support:
    - New migration: `supabase/migrations/20260219_venues_player_parking.sql` (`venues.player_parking text`).
    - Wired through admin venue create/edit APIs and forms.
    - Added `player_parking` display in venue admin row details.

- TI directory/demo polish:
  - TI tournament listing now pins `refereeinsights-demo-tournament` to the top regardless of date sort.
  - Updated locked premium teaser copy to use lowercase `food vendors`.
  - Demo tournament display rename prepared:
    - Updated seed name to `Demo Tournament` in `supabase/migrations/20260206_demo_reviews.sql`.
    - Added forward data migration to rename existing row by slug:
      - `supabase/migrations/20260219_demo_tournament_rename.sql`.

- Venue admin/edit hardening:
  - Removed `surface` from admin venue create/edit/list views and from venue update/create API payload handling.
  - Likely fix for generic "update failed" when DBs do not have a `venues.surface` column.
  - Venue update API now returns the underlying DB error message (instead of generic `update_failed`) to make future failures diagnosable in UI.
  - Expanded admin venue field coverage:
    - Added `lighting` and `amenities` to venue edit/create UI and API update/create handling.
    - Added `amenities` display in venues list row details.

- Admin tournament listings UX:
  - In the tournament edit/listings admin view, linked venues are now clickable and open venue details/edit pages.
  - Updated `apps/referee/app/admin/page.tsx` so each linked venue item routes to `/admin/venues/{venueId}`.
  - Validation: `npx tsc -p apps/referee/tsconfig.json --noEmit` passed.
- TI paid-tier gating added for tournament detail planning fields:
  - `apps/ti-web/app/tournaments/[slug]/page.tsx` now includes a premium-only section ("Premium Planning Details").
  - Public/free views show a locked teaser + Upgrade CTA (`/pricing`) and do not display premium values.
  - Paid path (currently env-gated via `TI_FORCE_PAID_TOURNAMENT_DETAILS=true`) conditionally fetches and renders:
    - `tournaments.travel_lodging` (shown as "Travel/Lodging Notes")
    - `venues.food_vendors`, `venues.restrooms`, `venues.amenities`.
  - Added supporting premium section styles in `apps/ti-web/app/tournaments/tournaments.css`.
  - Confirmed TI typecheck passes: `npx tsc -p apps/ti-web/tsconfig.json --noEmit`.

## 2026-02-18
- Fees/venue scraper hardening + reliability fixes (post-initial rollout):
  - Added clearer error classification for stale DB constraints in `apps/referee/app/api/admin/tournaments/enrichment/fees-venue/route.ts`:
    - explicit handling for `tournament_attribute_candidates_value_check` failures.
  - Added fallback tolerance for missing cooldown column errors in both PostgREST message formats:
    - `column ... does not exist`
    - `Could not find the 'fees_venue_scraped_at' column ... schema cache`
  - Added duplicate-safe candidate insert behavior:
    - de-dupes within scrape batch
    - skips rows already present in `tournament_attribute_candidates`
    - prevents whole-run failure on `tournament_attribute_candidates_dedupe_idx`.
  - Added queue UX auto-refresh after successful fees/venue insert so new candidates appear immediately in â€œApprove enrichment by tournamentâ€:
    - `apps/referee/app/admin/tournaments/enrichment/EnrichmentClient.tsx`.
  - Added tiered fee extraction support for patterns like:
    - `U6-U10 | $795`, `U11-U12 | $895`, `U13-U19 | $1095`
    - stored as combined `team_fee` candidate string: `U6-U10 $795 | U11-U12 $895 | U13-U19 $1095`.
- Team fee data model consistency updates:
  - Enrichment apply path now persists `team_fee` as text (preserves labeled/tiered fee strings), not numeric-only parsing:
    - `apps/referee/app/api/admin/tournaments/enrichment/apply/route.ts`.
  - Admin editor `team_fee` input switched from numeric to text:
    - `apps/referee/app/admin/page.tsx`.
  - Admin types updated so `team_fee` is `string | null`:
    - `apps/referee/lib/admin.ts`.
- Tournament card/count UI updates:
  - Total tournaments tile now reflects currently displayed tournaments (post-filter) instead of global DB count:
    - `apps/referee/app/tournaments/page.tsx`
    - `apps/ti-web/app/tournaments/page.tsx`.
  - Increased sport SVG icon sizing on tournament cards and summary cards (including lacrosse visibility improvements):
    - `apps/referee/app/tournaments/tournaments.css`
    - `apps/ti-web/app/tournaments/tournaments.css`.
- TI mark/icon asset updates:
  - Added transparent TI mark asset:
    - `shared-assets/svg/ti/tournamentinsights_mark_transparent.svg`.
  - Cropped transparent mark viewBox so it renders at expected visual size in summary tiles.
  - TI total tournaments tile now uses transparent TI mark icon:
    - `apps/ti-web/app/tournaments/page.tsx`.
- Commits pushed during this phase:
  - `2005d50` TI/RI: update tournament cards and enrichment workflow
  - `6227988` Enrichment: clarify fees/venue constraint error
  - `daf3c8c` Enrichment: tolerate missing cooldown column schema-cache errors
  - `727a41b` Enrichment: skip duplicate fee/venue candidates
  - `61f0fa4` Enrichment: support labeled tiered team fees
- TI homepage copy refresh:
  - Committed `ed9cb02` (`TI: update homepage value props copy`) in `apps/ti-web/app/page.tsx`.
  - Updated home â€œWhat TournamentInsights Providesâ€ section with new value-prop bullets and replaced defensive â€œnot a review platform / no ratingsâ€ language on the homepage.
  - Updated homepage metadata description in `apps/ti-web/app/page.tsx` to remove â€œno ratings or reviewsâ€.
- Enrichment visibility + scrape controls:
  - Added persistent â€œRecent fees/venue findingsâ€ feed on `/admin/tournaments/enrichment` so recent fee/venue candidates remain visible after refresh, even when approval items are hidden because DB fields are already populated.
  - Files:
    - `apps/referee/app/admin/tournaments/enrichment/page.tsx`
    - `apps/referee/app/admin/tournaments/enrichment/EnrichmentClient.tsx`
  - Added fees/venue scrape cooldown support: scraper now skips tournaments scraped in last 10 days, stamps `fees_venue_scraped_at` on attempted tournaments, and reports skipped count in UI.
  - Files:
    - `apps/referee/app/api/admin/tournaments/enrichment/fees-venue/route.ts`
    - `apps/referee/app/admin/tournaments/enrichment/EnrichmentClient.tsx`
    - `supabase/migrations/20260218_tournaments_fees_venue_scrape_cooldown.sql`
  - Backward compatibility: fees/venue route gracefully falls back if `fees_venue_scraped_at` column is not yet present.
- Git/workflow:
  - Pulled latest `origin/main` after stashing local edits and merged stash back in.
  - Confirmed no DB writes during git-only operations.
  - Committed and pushed:
    - `f88d969` Add enrichment edit shortcut and fees scrape DB fallback.
    - `e1b210d` Expand tournament admin editor and slim enrichment attributes.
- Fees/venue enrichment stability:
  - Updated `apps/referee/app/api/admin/tournaments/enrichment/fees-venue/route.ts` to gracefully fallback when `team_fee`/`games_guaranteed` columns are missing (no hard failure on pre-migration DBs).
  - Added migration file `supabase/migrations/20260217_tournaments_age_fee.sql` locally (repo has `supabase/` ignored), and applied equivalent migration to linked remote DB.
  - Verified live DB now has:
    - `tournaments.age_group`, `tournaments.team_fee`, `tournaments.games_guaranteed`
    - `tournaments_public.age_group`, `tournaments_public.team_fee`, `tournaments_public.games_guaranteed`
- Enrichment queue UX:
  - Added `Edit` button beside `Apply/Delete` in `apps/referee/app/admin/tournaments/enrichment/EnrichmentClient.tsx`, linking to `/admin?tab=tournament-listings&q=...`.
  - Updated enrichment queue filtering in `apps/referee/app/admin/tournaments/enrichment/page.tsx` so review items are hidden when authoritative tournament fields are already populated (DB-first behavior).
- Enrichment scope reduction (requested):
  - Removed these attribute keys from active enrichment flow:
    - `cash_at_field`
    - `referee_food`
    - `referee_tents`
    - `ref_game_schedule`
    - `ref_parking`
    - `ref_parking_cost`
    - `mentors`
    - `assigned_appropriately`
  - Implementation:
    - `apps/referee/src/server/enrichment/extract.ts`: attribute extraction disabled (`extractAttributes` returns empty array).
    - `apps/referee/app/api/admin/tournaments/enrichment/apply/route.ts`: removed apply/write logic for those keys.
    - `apps/referee/app/admin/tournaments/enrichment/page.tsx`: excluded legacy rows for those keys from queue rendering.
    - `apps/referee/app/admin/tournaments/enrichment/EnrichmentClient.tsx`: removed label mappings for those keys.
- Admin tournament editor expansion:
  - Exposed and persisted additional fields on `/admin?tab=tournament-listings`:
    - `team_fee`, `games_guaranteed`, `age_group`
    - `official_website_url`, `venue_url`, `zip`
  - Updated query/types/update path:
    - `apps/referee/lib/admin.ts`
    - `apps/referee/app/admin/page.tsx`
- US Club Lax parser + lacrosse sweep support:
  - Added direct parser/ingest path for `https://usclublax.com/tournaments/` in `apps/referee/src/server/admin/pasteUrl.ts`.
  - New parser extracts tournament name, event URL, location (`city/state`), grade text, fee text, and date range from `table.uscl-table`.
  - Date parsing supports same-month (`May 30-31, 2026`) and cross-month (`May 31-Jun 1, 2026`) ranges.
  - Imported records are saved as `sport='lacrosse'`, `source='external_crawl'`, queued for enrichment, and logged as `usclublax_import`.
  - Expanded tournament sport typing and admin sweep sport allowlists to include lacrosse:
    - `apps/referee/lib/types/tournament.ts`
    - `apps/referee/lib/tournaments/importUtils.ts`
    - `apps/referee/app/admin/page.tsx`
    - `apps/referee/app/admin/tournaments/sources/page.tsx`
  - Added parser test coverage in `apps/referee/src/server/admin/__tests__/pasteUrl.test.ts`.
- Duplicate control updates (approval queue + US Club Soccer):
  - Pending approval list now dedupes draft rows in `adminListPendingTournaments()` by normalized `name + city + state + start_date` before rendering.
  - Fixed admin cleanup/queue actions that were incorrectly targeting `status='pending'`; they now target `status='draft'`:
    - `dedupePendingTournamentsAction`
    - `queuePendingEnrichmentAction`
  - Stabilized US Club Soccer source identity to reduce re-import duplicates:
    - `source_event_id` now uses normalized `name|state|start_date|end_date` (instead of raw date text).
    - Added in-run dedupe for parsed US Club Soccer rows by `source_event_id`.

## 2026-02-12
- Workflow:
  - Keep `docs/notes.md` updated as changes are made so this file remains the running history.
- Architecture snapshot (repo review):
  - Monorepo workspaces: `apps/*` + `packages/*` (root `package.json`).
  - Primary product app: `apps/referee` (Next.js App Router + API routes + admin tools).
  - Additional sites: `apps/corp` (marketing) and `apps/ti-web` (holding page).
  - Separate automation/integration test workspace: `RI_Backend` (Playwright + scripts).
- Supabase architecture snapshot:
  - Migration-first schema in `supabase/migrations`; heavy RLS usage with admin-gated policies.
  - Core entities already present: `tournaments`, `tournament_sources`, `tournament_contacts`, `venues`, `tournament_venues`, `profiles`, `assignors`, `assignor_contacts`.
  - Enrichment pipeline tables: `tournament_enrichment_jobs`, contact/venue/comp candidates, URL candidates/suggestions, source logs, attribute candidates.
  - Outreach/staff verification tables: `tournament_outreach`, `outreach_email_templates`, `tournament_staff_verify_tokens`, `tournament_staff_verification_submissions`, `tournament_staff_verified` fields on tournaments.
  - Discovery quality controls: `tournament_email_discovery_runs`, `tournament_email_discovery_results`, `tournament_dead_domains`, duplicate dismissals, enrichment skip/dismiss fields.
  - Referrals + monetization/supporting tables: `referral_codes`, `referrals`, `outbound_clicks`.
  - Edge function present: `supabase/functions/assignor-crawl-cnra/index.ts` (authorized CNRA crawl, writes to `assignor_crawl_runs` and related source tables).
- Supabase deep map (table -> app usage):
  - Tournament read surfaces:
    - Public tournament pages and hubs read from `tournaments`, `tournament_referee_scores`, `tournament_referee_reviews_public`, `tournament_venues`, `tournament_contacts`, `tournament_engagement_rolling`.
    - Files: `apps/referee/app/tournaments/page.tsx`, `apps/referee/app/tournaments/[slug]/page.tsx`, `apps/referee/app/tournaments/hubs/[sport]/page.tsx`, `apps/referee/app/tournaments/hubs/[sport]/[state]/page.tsx`.
  - Tournament admin/enrichment:
    - Admin dashboard, enrichment, and source tooling use `tournament_enrichment_jobs`, `tournament_contact_candidates`, `tournament_venue_candidates`, `tournament_referee_comp_candidates`, `tournament_date_candidates`, `tournament_attribute_candidates`, `tournament_sources`, `tournament_source_logs`, `tournament_url_candidates`, `tournament_url_suggestions`.
    - Files: `apps/referee/app/admin/page.tsx`, `apps/referee/app/admin/tournaments/enrichment/page.tsx`, `apps/referee/src/server/enrichment/pipeline.ts`, `apps/referee/src/server/admin/sources.ts`, plus `/api/admin/tournaments/enrichment/*` routes.
  - Email discovery and data hygiene:
    - Admin flow reads/writes `tournament_email_discovery_runs` + `tournament_email_discovery_results`; dead-domain skiplist is `tournament_dead_domains`.
    - Files: `apps/referee/app/admin/page.tsx`, `apps/referee/app/api/admin/tournaments/enrichment/email-discovery/route.ts`, migration `supabase/migrations/20260212_tournament_dead_domains.sql`.
  - Tournament outreach + staff verification:
    - Outreach tooling uses `tournament_outreach`, `outreach_email_templates`, `tournament_staff_verify_tokens`, `tournament_staff_verification_submissions`, and updates staff-verified fields on `tournaments`.
    - Files: `apps/referee/app/admin/outreach/page.tsx`, `apps/referee/app/admin/tournaments/staff-verification-queue/page.tsx`, `apps/referee/app/tournaments/verify/[token]/page.tsx`.
  - Reviews and scoring:
    - Tournament reviews: `tournament_referee_reviews`, `tournament_referee_scores`, `tournament_referee_reviews_public`.
    - School reviews: `schools`, `school_referee_reviews`, `school_referee_reviews_public`, `school_referee_scores`, `school_referee_scores_by_sport`.
    - Files: `apps/referee/app/api/referee-reviews/route.ts`, `apps/referee/app/api/schools/reviews/route.ts`, `apps/referee/lib/whistleScores.ts`, `apps/referee/lib/admin.ts`.
  - Assignor discovery + public directory:
    - Assignor flows use `assignors`, `assignor_contacts`, `assignor_coverage`, `assignor_zip_codes`, `assignor_sources`, `assignor_crawl_runs`, `assignor_source_records`.
    - Public-safe discovery view/function and audit/rate limit tables: `assignor_directory_public` / `assignor_directory_public_fn()`, `contact_access_log`, `assignor_claim_requests`, `rate_limit_events`.
    - Files: `apps/referee/app/assignors/page.tsx`, `apps/referee/app/admin/assignors/*`, `apps/referee/app/api/atlas/*`, `supabase/functions/assignor-crawl-cnra/index.ts`.
  - Accounts, referrals, clicks, alerts:
    - Account and auth-adjacent usage: `profiles`, `badges`, `user_badges`, `referee_verification_requests`, `alert_preferences`, `subscriptions`.
    - Referral/click tracking: `referral_codes`, `referrals`, `outbound_clicks`.
    - Files: `apps/referee/lib/profile.ts`, `apps/referee/lib/admin.ts`, `apps/referee/app/account/alerts/page.tsx`, `apps/referee/app/api/referrals/route.ts`, `apps/referee/app/go/route.ts`.
- RLS / policy posture (from migrations):
  - Default pattern for sensitive ops tables is RLS enabled + admin-all policy via `public.is_admin()`.
  - Public access is intentionally narrow:
    - `assignor_directory_public` exposed for read with masked contact data.
    - `tournament_url_suggestions` includes public insert policy for user submissions.
    - `referral_codes`/`referrals` are self-scoped policies.
  - Security hardening migration (`20250112_security_hardening.sql`) centrally enforced RLS across multiple legacy tables and added public-select + admin-write split for selected views/tables.
- Follow-up items for future notes updates:
  - Built route-to-table matrix doc: `docs/overview/architecture/supabase-map.md` (ownership, write paths, RLS posture, and high-risk endpoints).
  - Add an RPC/function inventory (`process_assignor_crawl_run`, `process_assignor_source_record`, etc.) with ownership and side effects.
  - Add a â€œcritical write pathsâ€ checklist for admin flows (enrichment apply, outreach send, email discovery run).
- Parser architecture docs:
  - Added `docs/overview/architecture/parser-map.md` with parser trigger map, domain-specific parser inventory, enrichment extractor details, DB write mapping, diagnostics model, and current test coverage.
  - Added parser runbook section with concrete manual test steps (admin flows, API endpoints, expected DB writes, test commands, and triage checklist).
- Smoke validation run:
  - `scripts/smoke.sh` passed when run with full network access (Supabase REST returned `200`, Google Places returned `200`, TI map check skipped due optional env vars not set).
  - `npm run sweep:asa-az` passed after loading `NEXT_PUBLIC_SUPABASE_URL` + `SUPABASE_SERVICE_ROLE_KEY` from `.env.local`; result: `found=50`, `with_website=50`, `with_email=49`, `with_phone=49`.
  - `cd RI_Backend && npm run smoke:feedback` passed against local dev server (`localhost:3000`) and successfully inserted + cleaned up feedback row.
- Cron smoke integration:
  - Extended `apps/referee/app/api/cron/whistles/route.ts` to run lightweight smoke probes in the same scheduled cron call (no extra Vercel cron slot).
  - Added checks: Supabase anon REST, `tournament_dead_domains` table queryability, Google Places nearby probe (skip when key missing), and ASA source reachability.
  - Added opt-out toggle: `smoke=0`/`false`/`off`; smoke failures now return HTTP `500` with per-check details while still including whistle-run payload.
  - Added optional cron report emails with detailed smoke + whistle JSON payloads.
    - `CRON_REPORT_EMAILS` (comma-separated recipients)
    - `CRON_REPORT_EMAIL_MODE` (`failures` default, `always`, `never`)
    - `CRON_REPORT_FROM` (optional sender override)
    - Uses existing `RESEND_API_KEY` mail transport.
- State filter defaults:
  - Updated `apps/referee/app/admin/tournaments/dashboard/page.tsx` so no selected state now defaults to **All states** (instead of the previous West-region subset), matching tournaments page behavior.
- Tournaments count alignment notes:
  - Count gap explanation (`/admin/tournaments/dashboard` vs `/tournaments`): admin dashboard includes multiple statuses and records with null dates; public tournaments page restricts to `status=published`, `is_canonical=true`, and excludes past events unless `includePast=true`.
  - Added state-level counts to the state dropdown in public tournaments filters (`apps/referee/app/tournaments/page.tsx` and sport hubs in `apps/referee/app/tournaments/hubs/[sport]/page.tsx`) via shared `apps/referee/app/tournaments/StateMultiSelect.tsx`.
- Soccer SEO state hubs:
  - Added static SEO routes:
    - `/tournaments/hubs/soccer/california`
    - `/tournaments/hubs/soccer/florida`
    - `/tournaments/hubs/soccer/arizona`
    - `/tournaments/hubs/soccer/north-carolina`
  - Refactored hub rendering into shared component `apps/referee/app/tournaments/hubs/_components/SportHubPage.tsx` and routed existing dynamic sport hub through it.
  - State SEO pages now:
    - enforce soccer + fixed state scope
    - show only two toggles (`reviewed`, `past`) with URL persistence (`?reviewed=1&past=1`)
    - replace search area with total-count block and update note
    - include state-specific metadata + canonical + unique intro copy
  - Added helper `getSoccerStateUpcomingCount` for metadata counts.
  - UI tweak: centered the â€œTotal tournamentsâ€ count block over the filter controls on state SEO pages by overriding the state-seo filter grid layout in `apps/referee/app/tournaments/hubs/_components/SportHubPage.tsx`.
- Improved email discovery extraction:
  - Added Cloudflare email decoding support (`data-cfemail` + `/cdn-cgi/l/email-protection`).
  - Added text-only email scan after removing scripts/styles.
  - Normalized mailto emails to strip query/fragment/punctuation.
  - Prioritized contact/referee/assignor/staff/about links during crawl.
- Email discovery UI:
  - Added summary line: â€œFound emails for X of Y tournamentsâ€.
  - Added Run ID display next to latest run timestamp.
- Dead domain skiplist:
  - New table `public.tournament_dead_domains` via migration `supabase/migrations/20260212_tournament_dead_domains.sql`.
  - Email discovery now DNS-checks domains; `ENOTFOUND` domains are recorded and skipped on future runs.
- Commit: `ead8b99` â€œImprove email discovery and skip dead domainsâ€.
- Deep date backfill improvements:
  - Added a deep date-search mode to enrichment batch (`/api/admin/tournaments/enrichment/queue-all`) with `missing_dates_only` + `deep_date_search` flags.
  - Deep mode targets tournaments missing both `start_date` and `end_date`, crawls deeper (`maxPages=16`), and prioritizes date/schedule/calendar links.
  - Enrichment admin UI now has a checkbox to run deep date search only for missing-date tournaments.
  - Date extraction expanded to parse month abbreviations (`Mar 14-16, 2026`) and numeric formats (`02/20/2026`) in date-context lines.
  - Added extraction test coverage for new date formats in `apps/referee/src/server/enrichment/enrichment.test.ts`.
  - AZ run snapshot (manual execution):
    - Targeted `AZ + soccer + published + canonical + missing start/end date` tournaments.
    - Processed: `53`, errors: `0`.
    - `tournaments` date fields recovered immediately: `0` (no auto-apply in deep run yet).
    - New/existing pending date candidates for those tournaments: `161` total, `67` with parsed `start_date`/`end_date` (ready for admin apply workflow).
- Enrichment queue UX improvement:
  - Updated `apps/referee/app/admin/tournaments/enrichment/page.tsx` to load pending candidate rows with pagination across all candidate tables (instead of small per-table limits).
  - This allows the â€œApprove enrichment by tournamentâ€ section to aggregate full pending data per tournament in one load, reducing repeat approvals for the same tournament across refreshes.
  - Fixed missing tournament links in approval queue: candidate tournament lookup now fetches IDs in chunks (no `limit(200)` truncation), so URL links under tournament ID remain populated for full queues.
- Oregon sanctioned tournaments parser:
  - Added custom parser branch in `apps/referee/src/server/admin/pasteUrl.ts` for `oregonyouthsoccer.org/sanctioned-tournaments`.
  - Parser reads sanctioned tournament paragraph/link entries, extracts tournament names + date ranges (including multi-weekend formats), and imports as OR soccer tournaments.
  - Added source seed migration: `supabase/migrations/20260212_seed_oregon_custom_parser_source.sql`.
  - Added parser test coverage in `apps/referee/src/server/admin/__tests__/pasteUrl.test.ts`.
- Source registry UX:
  - Added `oregonyouthsoccer.org` to custom-crawler host list in `apps/referee/src/server/admin/sources.ts` so Oregon source URLs auto-mark as `is_custom_source=true` (green custom indicator).
  - Updated sources table sort in `apps/referee/app/admin/tournaments/sources/page.tsx` to include `created_at` and prioritize newer rows within review-status ordering, so newly added URLs float to the top more reliably.
- Enrichment scope reduction (phone + venue):
  - Stopped venue candidate creation in enrichment pipeline (`apps/referee/src/server/enrichment/pipeline.ts` now passes no venue candidates to persistence).
  - Contact candidate persistence now nulls phone values before dedupe/insert so phone numbers are no longer carried through enrichment candidates.
  - Approval UI no longer renders venue review items and contact details now show email only (`apps/referee/app/admin/tournaments/enrichment/EnrichmentClient.tsx`).
  - Enrichment page no longer fetches pending venue candidates (`apps/referee/app/admin/tournaments/enrichment/page.tsx`).
  - Apply route no longer writes phone values from contact candidates into `tournament_contacts` or tournament phone fields (`apps/referee/app/api/admin/tournaments/enrichment/apply/route.ts`).
  - One-time cleanup run completed:
    - pending venue candidates: `0 -> 0`
    - pending phone-bearing contact candidates: `970 -> 0` (deleted pending rows with phone values)
- Tournament data hardening (anti-scrape phase 1-3):
  - Added migration `supabase/migrations/20260212_tournaments_public_surface_and_rls.sql`:
    - enables RLS on `public.tournaments`
    - drops non-admin tournaments policies
    - creates admin-only tournaments policy `admin_all_tournaments`
    - creates constrained view `public.tournaments_public` (published + canonical fields only)
    - revokes anon/authenticated access to `tournaments_public`; grants select to `service_role`
  - Added controlled public API path:
    - `apps/referee/app/api/tournaments/public/route.ts`
    - supports filtered, paginated reads over the constrained public surface
  - Updated public tournament surfaces to use the constrained server-side surface via `supabaseAdmin`:
    - `apps/referee/app/tournaments/page.tsx`
    - `apps/referee/app/tournaments/[slug]/page.tsx`
    - `apps/referee/app/tournaments/hubs/_components/SportHubPage.tsx`
    - `apps/referee/app/tournaments/hubs/[sport]/[state]/page.tsx`
    - `apps/referee/app/sitemap.ts`
- Enrichment scope reduction (venues + comp + noisy attributes):
  - Stopped surfacing pending referee comp candidates in enrichment queue (`apps/referee/app/admin/tournaments/enrichment/page.tsx`, `apps/referee/app/admin/tournaments/enrichment/EnrichmentClient.tsx`).
  - Stopped extracting/persisting referee comp candidates from page enrichment runs (`apps/referee/src/server/enrichment/extract.ts`, `apps/referee/src/server/enrichment/pipeline.ts`).
  - Stopped generating `facilities` and `travel_lodging` attribute candidates in extractor (`apps/referee/src/server/enrichment/extract.ts`, `apps/referee/src/server/enrichment/types.ts`).
  - Apply route no longer writes `facilities` or `travel_lodging` from attribute candidates (`apps/referee/app/api/admin/tournaments/enrichment/apply/route.ts`).
  - One-time pending queue cleanup run completed:
    - pending referee comp candidates: `97 -> 0`
    - pending noisy attributes (`facilities`,`travel_lodging`): `181 -> 0`
- Tournament director verification form update:
  - Added required `state` field between city and zip on token verification flow and preview page.
  - State input now enforces 2-letter abbreviation format and normalizes to uppercase on submit.
  - Included `state` in verification snapshot/proposed diff pipeline so admin review shows/apply includes it.
  - Added optional `additional_venues` input on verification form (one venue per line, optional `| address` format).
  - Admin approval now parses submitted additional venues and links them into `venues` + `tournament_venues`.
- Enrichment to outreach handoff for low-information tournaments:
  - Added a new â€œPriority outreach targets (missing both emails + dates)â€ panel in enrichment UI:
    - `apps/referee/app/admin/tournaments/enrichment/page.tsx`
    - `apps/referee/app/admin/tournaments/enrichment/EnrichmentClient.tsx`
  - Priority list is scoped to `published + canonical + do_not_contact=false + start/end date missing + both emails missing`, and excludes tournaments already in `tournament_outreach`.
  - Added API endpoint to batch add selected targets directly into outreach draft:
    - `apps/referee/app/api/admin/outreach/queue/route.ts`
  - Inserted outreach rows use `status='draft'` with notes flag `priority_target_missing_both_emails_and_dates` so admins can quickly add email and proceed with manual outreach.
- Listing badges for verified + mentors:
  - Added `mentors` and `tournament_staff_verified` to constrained public view via migration:
    - `supabase/migrations/20260212_tournaments_public_add_badge_fields.sql`
  - Tournament list cards now show badges around the sport icon:
    - left badge: `Verified` when `tournament_staff_verified=true`
    - right badge: `Mentors` when `mentors='yes'`
    - files: `apps/referee/app/tournaments/page.tsx`, `apps/referee/app/tournaments/tournaments.css`
  - Demo tournament updated in DB:
    - slug `refereeinsights-demo-tournament` set to `mentors='yes'` and `tournament_staff_verified=true`.

### Actions to run after reboot
- Apply migration: `supabase/migrations/20260212_tournament_dead_domains.sql`.

### Notes
- Email discovery runs are admin-only; use `/admin?tab=tournament-contacts` â†’ â€œDiscover contactsâ€.
- If discovery appears stuck, check terminal logs for `[enricher]` errors; DNS failures are expected and now skipped.
- Outreach + detail UX updates:
  - Outreach queue now shows status pills beside tournament name with explicit date labels (e.g. `Email sent - Feb 12, 2026`) after `Mark sent` in `apps/referee/app/admin/outreach/page.tsx`.
  - Public tournament detail page now loads additional tournament fields for logged-in users directly from `public.tournaments` (without exposing them in `tournaments_public`):
    - `referee_pay`, `referee_contact`, `referee_contact_email`, `referee_contact_phone`, `tournament_director`, `tournament_director_email`, `tournament_director_phone`, `cash_tournament`.
  - Logged-in detail rows now render only populated values (no placeholder rows).
  - Referee score/category pills on detail page updated for high-contrast readability on dark cards.
  - Venue UX improvements on detail page (no login required):
    - supports single and multi-venue display from `tournament_venues`.
    - each venue now includes direct mobile map links for Google Maps, Apple Maps, and Waze.
- Demo tournament data setup:
  - Updated `RefereeInsights Demo Tournament` with:
    - `tournament_director_email=rod@refereeinsights.com`
    - `referee_contact_email=rod@refereeinsights.com`

## 2026-02-17
- Schema:
  - Added optional `age_group`, `team_fee`, and `games_guaranteed` columns to `tournaments` and `tournaments_public` (`20260217_tournaments_age_fee.sql`) to capture division info, team fees, and games guaranteed.
- Parsers:
  - Exposure Baseball (WA tournaments page) check: static HTML and Playwright render show only promo â€œAD YOUR EVENT NOWâ€ cards; no tournament listings or event links. Network/XHR during page load only hits the page itself, banner endpoint (`/banner/events?stateregion=washington&sportType=5`), and ads/analyticsâ€”no tournament JSON. Conclusion: WA page currently has no events; need a different state or to wait until events exist before building a parser.
- Enrichment (planned):
  - Add a â€œFees & Venue Enrichmentâ€ flow to admin enrichment: new API to select tournaments missing `team_fee`/`games_guaranteed`/venue/address/venue_url`, scrape official/source URLs, store candidates (likely via `tournament_attribute_candidates` keys `team_fee`, `games_guaranteed`, `venue`, `address`, `venue_url`), and surface them in the existing review/approval UI with Accept/Reject before writing to `tournaments`/`tournaments_public`.
- Enrichment (backend scaffold):
  - Added admin API `POST /api/admin/tournaments/enrichment/fees-venue` to queue and scrape tournaments missing `team_fee`/`games_guaranteed`/venue/address/venue_url`. It fetches the official/source URL, parses fee, games-guaranteed, address, and map links, and inserts `tournament_attribute_candidates` (keys: `team_fee`, `games_guaranteed`, `address`, `venue_url`) with the source URL for later review/approval.

## 2026-02-14
- Smoke tests:
  - Adjusted Playwright admin smoke selectors to tolerate multiple verification links and optional tournament contacts heading.
  - Relaxed prod smoke expectations for tournaments page heading and password reset API (allows 500 with reset error message).
  - Updated hero copy expectation to â€œPublic Betaâ€.
  - Current status: external host `https://refereeinsights.com` timing out from this environment, so prod/admin smokes fail on navigation; rerun when reachable or point `RI_TARGET_URL` to a live instance.
  - Further tweaks: admin login helper waits for form and allows either URL change or admin heading; footer text expectation loosened to tolerate whitespace changes.
- Schema:
  - Added venue enrichment columns (geo + amenities) in `20260214_venues_enhancements.sql`: latitude/longitude, normalized/geocoded address source, timezone, surface/field_type, indoor/lighting flags, parking notes, field rating (1-5), venue type enum, field count, amenity booleans (field_monitors, referee_mentors, food/coffee/tournament_vendors), restrooms type (portable/building/both) and cleanliness (1-5).
  - Added extras to venue enrichment: field_lighting boolean and referee_tent enum (`yes`,`no`,`multiple`).
  - Added `venue_url` column to venues (enrichment migration).
- Admin venues UI:
  - Venues index now has collapsible rows (name summary) with search/filters (name/address/city/state/UUID/tournament name, sport, state), expanded metadata, and linked tournaments.
  - Added multi-select tournament association: search tournaments, add/remove links, and save in place.
  - Added venue edit page with full field coverage for new enrichment columns and tournaments-at-this-venue list.
  - Added admin API for venue fetch/update/delete (`/api/admin/venues/[id]`) with tournament link management.
  - Edit page now surfaces detailed fetch errors instead of generic failures when venue load fails.
  - Fixed non-iterable tournament list crash on venue edit by guarding array shapes.
  - New venue form now exposes all venue enrichment fields, including venue URL; create/edit accepts and stores venue URL and all enrichment fields.
  - Added Google Places admin search endpoint and wired the new venue form to fetch suggestions to prefill address/geo/URL.
- Places suggestions now prefill city/state/ZIP; removed duplicate â€œlightingâ€ field (keep field_lighting), added paid_parking boolean in forms/API/migration.
  - `referee_pay=$50 per game`
- Added and linked demo venues:
  - `Rainier Vista Soccer Complex` (Seattle, WA)
  - `Cedar River Athletic Fields` (Renton, WA)
  - Demo tournament currently has 3 linked venues total (including existing `RefereeInsights Field`).
- Fix: admin venue update no longer tries to write a non-existent `tournament_ids` column (prevents update_failed when saving tournament links).
- Priority outreach queue hygiene:
  - Added bulk action for Priority Outreach targets: `Hide selected (no contact)` in `apps/referee/app/admin/tournaments/enrichment/EnrichmentClient.tsx`.
  - New admin API route `apps/referee/app/api/admin/outreach/priority-dismiss/route.ts` marks selected tournaments as:
    - `do_not_contact=true`
    - `do_not_contact_reason='no_email_contact_found_on_website'`
    - `do_not_contact_at=now()`
  - Also suppresses existing outreach rows for those tournaments (`status='suppressed'`) when present.
  - This replaces hard-delete for no-contact cases so history is retained and entries are removed from priority queue safely.
- Outreach bad-email handling:
  - Added per-row action on `/admin/outreach`: `Bad email + stop enrichment`.
  - Action suppresses outreach for the tournament, marks the tournament as `do_not_contact=true`, sets `do_not_contact_reason='bad_email'`, and sets `enrichment_skip=true` to remove from future enrichment workflows.
  - If the bad email matches `tournament_director_email` or `referee_contact_email`, that field is cleared.
  - Appends a timestamped bad-email note to outreach row notes for audit trail.
- Priority outreach scope update:
  - `Priority outreach targets (missing both emails + dates)` now filters to `sport='soccer'` in `apps/referee/app/admin/tournaments/enrichment/page.tsx`.

## 2026-02-19
- Added MYHockey tournaments parser + sweep integration for source registry/import flow:
  - New sweep module: `apps/referee/src/server/sweeps/myHockeyTournaments.ts`
    - Detects `https://www.myhockeytournaments.com/search`
    - Parses tournament rows (`name`, `date range`, `city/state`, `detail URL`, `level`)
    - Imports as `sport='hockey'`
    - Upserts source registry and queues enrichment for imported IDs
  - Wired into paste/import pipeline:
    - `apps/referee/src/server/admin/pasteUrl.ts`
      - Added `isMyHockeySearchUrl` + `sweepMyHockeyTournaments` branch
      - Added host-based sport detection for `myhockeytournaments.com -> hockey`
      - Added content-based hockey score hints (`hockey`, `rink`)
  - Extended tournament sport type union to include hockey:
    - `apps/referee/lib/types/tournament.ts`
  - Added myhockey hosts to custom crawler host list:
    - `apps/referee/src/server/admin/sources.ts`

- Tournament card sport-container background refresh (TI + RI):
  - Added new shared container art assets under `shared-assets/svg/sports/`:
    - `stadium_image_container.svg` (initial pass)
    - `soccer_container.svg`
    - `basketball_court_container.svg`
    - `baseball_container.svg`
    - `softball_container.svg`
    - `football_container.svg`
    - `lacrosse_container.svg`
    - `hockey_container.svg`
  - Updated tournament card container backgrounds in both apps:
    - `apps/ti-web/app/tournaments/tournaments.css`
    - `apps/referee/app/tournaments/tournaments.css`
  - Applied zoomed container fill (`background-size: ... 230% auto`) for sport-specific cards to avoid centered/narrow image rendering and eliminate gray edge gaps.
  - Added dedicated lacrosse and hockey container classes (`bg-sport-lacrosse`, `bg-sport-hockey`) and updated sport-to-class mapping:
    - `apps/ti-web/app/tournaments/page.tsx`
    - `apps/referee/lib/ui/sportBackground.ts`
- RI tournament card whistle display fix for demo tournament:
  - Hardened `toWhistleScore` parsing in `apps/referee/app/tournaments/page.tsx` so `null/undefined/""` do not render a false score, while string numerics (e.g., `"70.00"`) still parse correctly.
  - Added targeted fallback: when the demo tournament (`refereeinsights-demo-tournament`) has no aggregated whistle row, RI now directly reads `tournament_referee_scores` by that tournament ID and injects it into card rendering.

- Venues admin save hardening + UX cleanup:
  - Fixed `venues_venue_type_allowed` failures by normalizing venue type inputs in create/update API routes (`sports complex` now maps to `complex`; only `complex|school|stadium|park` are persisted).
  - Added timezone auto-fill in venue create/update APIs from coordinates via Google Time Zone API; if lat/lng is missing, APIs geocode address first and then derive timezone.
  - Added helper `apps/referee/src/lib/google/timezoneFromCoordinates.ts`.
  - Venue create API now respects manually entered latitude/longitude (instead of always replacing with geocode).
- Admin/public field visibility cleanup:
  - Removed `lighting`/`field_lighting` from admin venue views/forms so these fields are no longer surfaced in the admin UI:
    - `apps/referee/components/admin/VenueEditForm.tsx`
    - `apps/referee/components/admin/NewVenueForm.tsx`
    - `apps/referee/components/admin/VenueRow.tsx`
    - `apps/referee/app/admin/venues/page.tsx`
  - API compatibility remains in place for existing DB columns; UI no longer exposes them.
- Venue seating/chairs planning signals:
  - Added migration `supabase/migrations/20260219_venues_spectator_seating.sql` with new columns:
    - `venues.spectator_seating` (`none|limited|bleachers|covered_bleachers|mixed`)
    - `venues.bring_field_chairs` (boolean)
    - `venues.seating_notes` (text)
  - Wired admin create/edit/save and list rendering for all three fields:
    - `apps/referee/components/admin/NewVenueForm.tsx`
    - `apps/referee/components/admin/VenueEditForm.tsx`
    - `apps/referee/components/admin/VenueRow.tsx`
    - `apps/referee/app/api/admin/venues/route.ts`
    - `apps/referee/app/api/admin/venues/[id]/route.ts`
  - TI paid tournament detail card now includes these venue planning fields under Premium Planning Details:
    - `spectator seating`, `bring field chairs`, and `seating notes`
    - file: `apps/ti-web/app/tournaments/[slug]/page.tsx`
- Added scoring schema fields (DB-only, no UI yet) via `supabase/migrations/20260219_tournament_venue_scoring_fields.sql`:
  - `venues` 1-5 score columns:
    - `field_court_condition_score`
    - `parking_convenience_score`
    - `spectator_seating_availability_score`
    - `shade_weather_protection_score`
    - `food_concessions_quality_score`
    - `overall_cleanliness_score`
    - `ease_of_navigation_score`
    - `accessibility_score`
    - `lighting_score`
  - `tournaments` 1-5 score columns:
    - `schedule_organization_score`
    - `organizer_communication_score`
    - `check_in_process_score`
    - `competition_level_accuracy_score`
    - `value_for_cost_score`
    - `game_scheduling_balance_score`
    - `overall_experience_score`
    - `weather_contingency_handling_score`
    - `vendor_merchandise_quality_score`
  - Added per-column check constraints for all new score fields (`between 1 and 5`).
- TI `/venues` directory page added (without changing `/tournaments` UI):
  - New route: `apps/ti-web/app/venues/page.tsx`
  - New styles: `apps/ti-web/app/venues/VenuesPage.module.css`
  - New card component: `apps/ti-web/components/venues/VenueCard.tsx` + `apps/ti-web/components/venues/VenueCard.module.css`
  - Reuses `/tournaments` filter/query-param conventions (`q`, `state`, `month`, `sports`, `includePast`) and state multi-select UI.
  - Adds sport summary badges with distinct venue counts per sport and clickable sport filtering with active-toggle clear behavior.
  - Venue sports are derived from linked tournaments (`tournament_venues -> tournaments.sport`) with fallback to `venues.sport` only when no tournament links exist.
  - Venues with no linked tournaments still appear in the directory and all-count baseline.
- Added admin tool **Venue Address Verify**:
  - API: `POST /api/admin/venues/address-verify`
  - UI panel on admin venues page: `apps/referee/components/admin/VenueAddressVerifyPanel.tsx`
  - Purpose: scan existing venues, parse full-address blobs in `address/address1` into `address1 + city + state + zip`, geocode missing lat/lng, derive timezone, and attempt venue website discovery via Google Places.
  - Supports batch controls: `limit`, `onlyIncomplete`, and `dryRun`.
  - Writes `geocode_source='venue_address_verify'` when geocode updates are applied.

- Owl's Eye + venue merge admin enhancements:
  - Owl's Eye run guard now blocks duplicate runs per `venue_id + sport` when an existing `owls_eye_runs` row is already `running` or `complete` (unless `force=true` is explicitly provided).
  - Updated API route:
    - `apps/referee/app/api/admin/owls-eye/run/route.ts`
  - Added admin-approved venue merge endpoint to consolidate duplicate venues:
    - New API: `POST /api/admin/venues/merge`
    - File: `apps/referee/app/api/admin/venues/merge/route.ts`
    - Behavior: moves tournament links from source venue into target venue (`tournament_venues` upsert with dedupe), attempts to re-point Owl's Eye run rows to kept venue, then deletes source venue.
  - Added merge UI control in admin venue row actions:
    - `apps/referee/components/admin/VenueActions.tsx`
    - `apps/referee/components/admin/VenueRow.tsx`
    - Flow: paste target venue UUID -> confirm -> merge.

## 2026-02-20
- Owl's Eye nearby expansion (RI admin + backend):
  - Added hotel support to nearby search pipeline:
    - `apps/referee/src/lib/google/nearbySearch.ts` now accepts `lodging` type and maps Google included types to `lodging/hotel`.
    - `apps/referee/src/owlseye/nearby/upsertNearbyForRun.ts` now fetches hotels with a ~20-mile radius (`HOTEL_RADIUS = 32187`) and persists category `hotel`.
    - Nearby metadata now includes `hotelCount`.
  - Added hotels to Owl's Eye run retrieval payload:
    - `apps/referee/app/api/admin/owls-eye/run/[runId]/route.ts` now returns `nearby.hotels` (name, distance, address, sponsor flags, maps URL).
  - Added hotels tab to admin Owl's Eye UI:
    - `apps/referee/app/admin/owls-eye/OwlsEyePanel.tsx` now supports tabs for `food`, `coffee`, and `hotels`, and surfaces hotel counts in nearby status summaries.
- Tournament card Owl's Eye badge signal (RI + TI):
  - Added shared Owl's Eye badge asset:
    - `shared-assets/svg/ri/owls_eye_badge.svg`
  - Added tournament-level `has Owl's Eye` detection by checking:
    - `tournament_venues` links for listed tournaments
    - matching `owls_eye_runs` rows (`running|complete`) for linked venues
    - existing `owls_eye_nearby_food` rows for those run IDs
  - RI listing cards now render Owl's Eye badge in the right footer badge slot when data exists:
    - `apps/referee/app/tournaments/page.tsx`
    - `apps/referee/app/tournaments/tournaments.css`
  - TI directory cards now render Owl's Eye badge below footer actions when data exists:
    - `apps/ti-web/app/tournaments/page.tsx`
    - `apps/ti-web/app/tournaments/tournaments.css`

- Admin dashboard + venues Owl's Eye management enhancements:
  - Added dashboard KPI widget for Owl's Eye coverage:
    - `apps/referee/app/admin/tournaments/dashboard/page.tsx`
    - New card: **Venues with Owl's Eye** (distinct linked venues with run status `running|complete` in current dashboard scope)
    - Includes quick link opening `/admin/venues?owl=with_data` in a new tab.
  - Expanded `/admin/venues` with Owl's Eye filtering and per-venue visibility:
    - `apps/referee/app/admin/venues/page.tsx`
    - New query filter `owl=all|with_data|without_data`
    - Computes and surfaces per-venue Owl's Eye fields:
      - latest run id
      - status
      - last run timestamp
      - nearby counts (food/coffee/hotels)
      - latest map URL
    - Handles environments missing `owls_eye_runs.updated_at` via fallback to `created_at`.
  - Expanded venue row UI to show Owl's Eye fields and enable manual map updates:
    - `apps/referee/components/admin/VenueRow.tsx`
    - Added visible Owl's Eye run/status/count fields.
    - Added editable **Set Owl's Eye map URL** input + save action.
  - Added admin API for manual Owl's Eye map URL upsert:
    - `apps/referee/app/api/admin/venues/[id]/owls-eye/route.ts`
    - Behavior:
      - ensures a run exists for the venue (creates manual override run if needed)
      - updates existing map artifact or inserts a new one for the latest run
      - admin-auth protected.
